<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>RC Nitro Tuning Wizard</title>

  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180.png">
  <link rel="icon" href="icons/icon-192.png">
  <meta name="theme-color" content="#0b0c10">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Nitro Wizard">

  <style>
    :root{
      --bg:#0b0c10;
      --card: rgba(20,24,33,.92);
      --muted:#a9b2bf;
      --text:#eef2ff;
      --border: rgba(255,255,255,.10);
      --accent:#6ea8fe;
      --good:#2ecc71;
      --bad:#ff6b6b;
      --warn:#f7c948;
      --radius:18px;
      --shadow: 0 14px 40px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(110,168,254,.20), transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(46,204,113,.10), transparent 55%),
        var(--bg);
      padding: max(14px, env(safe-area-inset-top)) 14px max(14px, env(safe-area-inset-bottom));
    }
    .wrap{max-width:920px; margin:0 auto;}
    .topbar{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin:10px 0 14px;}
    h1{font-size:20px; margin:0; letter-spacing:.2px}
    .sub{font-size:12px; color:var(--muted); margin-top:4px; line-height:1.35}
    .pill{border:1px solid var(--border); padding:7px 10px; border-radius:999px; font-size:12px; color:#cfe1ff; background: rgba(255,255,255,.03);}

    .tabs{display:flex; gap:10px; flex-wrap:wrap; margin: 0 0 12px;}
    .tab{border:1px solid var(--border); background: rgba(255,255,255,.03); color:var(--text); padding:10px 12px; border-radius: 999px; font-weight:900; font-size:13px; cursor:pointer;}
    .tab.active{border-color: rgba(110,168,254,.55); background: rgba(110,168,254,.12);}

    .grid{display:grid; grid-template-columns: 1fr; gap:12px;}
    @media(min-width:920px){ .grid{ grid-template-columns: 1.25fr .75fr; } }

    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }
    .card h2{margin:0 0 8px; font-size:14px; color:var(--muted); font-weight:900; letter-spacing:.2px;}
    .headline{margin:0 0 10px; font-size:20px; line-height:1.3; letter-spacing:.2px;}
    .hint{margin:0; color:var(--muted); font-size:13px; line-height:1.45; white-space:pre-line}

    .choiceCol{display:flex; flex-direction:column; gap:10px; margin-top:12px}
    .choice{
      text-align:left;
      width:100%;
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px 12px;
      background: rgba(255,255,255,.03);
      color: var(--text);
      cursor:pointer;
      font-size:15px;
      font-weight:900;
    }
    .choice:active{transform:scale(.99)}
    .choice small{display:block; margin-top:6px; font-size:12px; font-weight:800; color: var(--muted); line-height:1.35}
    .choice .tag{
      display:inline-block;
      font-size:11px;
      font-weight:950;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      margin-right:8px;
    }
    .tag.safe{ background: rgba(46,204,113,.10); }
    .tag.warn{ background: rgba(247,201,72,.12); }
    .tag.advice{ background: rgba(110,168,254,.12); }
    .tag.stop{ background: rgba(255,107,107,.12); }

    .miniRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    button{
      appearance:none; border:none; border-radius:14px;
      padding:12px 14px; font-size:15px; font-weight:950;
      cursor:pointer; flex:1 1 160px;
      color:#0b0c10;
    }
    .btnGhost{background: transparent; border:1px solid var(--border); color: var(--text);}
    .btnWarn{background: var(--warn);}
    .btnNext{background: var(--accent);}

    .list{list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:10px; max-height:420px; overflow:auto;}
    .item{border:1px solid var(--border); border-radius:14px; padding:10px 12px; background: rgba(255,255,255,.03);}
    .itemTop{display:flex; justify-content:space-between; gap:8px; align-items:flex-start;}
    .pill2{display:inline-block; font-size:11px; font-weight:950; padding:4px 9px; border-radius:999px; border:1px solid var(--border); background: rgba(255,255,255,.04);}
    .pill2.adjust{background: rgba(110,168,254,.12);}
    .pill2.note{background: rgba(255,255,255,.06);}
    .itemMsg{margin-top:7px; font-size:13px; line-height:1.35;}
    .itemMeta{margin-top:6px; font-size:11px; color: var(--muted);}

    /* modal */
    label{font-size:12px; color:var(--muted); font-weight:950; display:block; margin:8px 0 6px}
    select,input[type="text"]{
      width:100%; padding:12px 12px; border-radius:12px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.25);
      color: var(--text);
      font-size:15px;
      outline:none;
    }
    .rowInline{display:flex; gap:10px}
    .rowInline>div{flex:1}
    .smallHelp{font-size:12px; color:var(--muted); margin-top:10px; line-height:1.45}
  </style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div>
      <h1>RC Nitro Tuning Wizard</h1>
      <div class="sub">
        Test-gedreven tuning • IDLE / LSN / HSN • log + herstel naar baseline.<br>
        iPhone: Safari → Deel → <b>Zet op beginscherm</b>.
      </div>
    </div>
    <div class="pill" id="statusPill">Wizard</div>
  </div>

  <div class="tabs">
    <button class="tab active" id="tabWizard">Wizard</button>
    <button class="tab" id="tabLog">Log & herstel</button>
    <button class="tab" id="tabSettings">Instellingen</button>
  </div>

  <div class="grid">
    <div class="card" id="mainCard">
      <h2 id="stepTitle">Test</h2>
      <div class="headline" id="stepHeadline">…</div>
      <p class="hint" id="stepHint"> </p>

      <div class="choiceCol" id="choiceCol"></div>

      <div class="miniRow">
        <button class="btnGhost" id="btnBack">Terug</button>
        <button class="btnGhost" id="btnRestart">Opnieuw</button>
        <button class="btnWarn" id="btnQuickLog">+ Log aanpassing</button>
      </div>
    </div>

    <div class="card" id="sideCard">
      <h2>Laatste log-items</h2>
      <ul class="list" id="logPreview"></ul>
      <div class="miniRow">
        <button class="btnGhost" id="btnCopyLog">Kopieer log</button>
        <button class="btnWarn" id="btnUndoList">Herstel-lijst</button>
      </div>
      <p class="smallHelp">
        Baseline: <span id="baselineLabel"></span>
      </p>
    </div>
  </div>

  <!-- MODAL: Manual log -->
  <div id="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); padding:18px; z-index:9999;">
    <div class="card" style="max-width:680px; margin: max(16px, env(safe-area-inset-top)) auto;">
      <h2>Log een aanpassing</h2>
      <div class="headline" style="font-size:18px; margin-bottom:6px;">Wat heb je gedraaid?</div>
      <p class="hint">Registreer exact (1/16, 1/8, 1/4). Herstel-lijst draait later automatisch terug naar baseline.</p>

      <label>Needle</label>
      <select id="logNeedle">
        <option value="IDLE">IDLE screw</option>
        <option value="LSN">LSN (Low-speed)</option>
        <option value="HSN">HSN (High-speed)</option>
      </select>

      <div class="rowInline">
        <div>
          <label>Richting</label>
          <select id="logDir">
            <option value="CW">CW (met de klok mee) — leaner / idle omhoog</option>
            <option value="CCW">CCW (tegen de klok in) — richer / idle omlaag</option>
          </select>
        </div>
        <div>
          <label>Stap</label>
          <select id="logStep">
            <option value="1/16">1/16 slag</option>
            <option value="1/8" selected>1/8 slag</option>
            <option value="1/4">1/4 slag</option>
            <option value="1/2">1/2 slag</option>
          </select>
        </div>
      </div>

      <label>Notitie (optioneel)</label>
      <input type="text" id="logNote" placeholder="bijv. hang idle, bog bij gas, temp 225°, etc." />

      <div class="miniRow">
        <button class="btnNext" id="logSave">Opslaan</button>
        <button class="btnGhost" id="logCancel">Annuleren</button>
      </div>
    </div>
  </div>

  <!-- MODAL: Undo list -->
  <div id="modalUndo" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); padding:18px; z-index:9999;">
    <div class="card" style="max-width:720px; margin: max(16px, env(safe-area-inset-top)) auto;">
      <h2>Herstel-lijst (terug naar baseline)</h2>
      <div class="headline" style="font-size:18px; margin-bottom:6px;">Draai deze stappen terug</div>
      <p class="hint" id="undoHint">…</p>

      <ul class="list" id="undoList" style="max-height:360px;"></ul>

      <div class="miniRow">
        <button class="btnGhost" id="undoClose">Sluiten</button>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================================================
   TEST-DRIVEN FLOW (IDLE / LSN / HSN)
   - almost everything is a TEST step
   - adjustments are output of test (auto-logged)
   - flowchart path preserved (idle → low → high → temp → idle)
========================================================= */

const FLOW = {
  start: {
    title: "Start (setup check)",
    headline: "Klaar om te testen?",
    hint:
      "Voor betrouwbare tests:\n" +
      "• Motor warm (paar minuutjes rustig rijden)\n" +
      "• Verse brandstof, goede plug, schoon filter\n" +
      "• Geen luchtlekken / goede tankdruk\n" +
      "• Carb opening ~1mm (basis idle)\n\n" +
      "Aanrader: zet nu een baseline (Instellingen) als je op factory staat.",
    choices: [
      { label: "Ik ben klaar → naar IDLE stabiliteit test", next: "idle_stability_60s", tag:"safe" },
      { label: "Ik wil eerst baseline zetten", next: "jump_settings", tag:"advice" }
    ]
  },
  jump_settings: { jumpToView: "settings" },

  /* ---------------- IDLE TESTS ---------------- */
  idle_stability_60s: {
    title: "IDLE test 1/5",
    headline: "Stationair 60 seconden: wat doet hij?",
    hint:
      "Laat hem stationair staan (zonder gas).\n" +
      "Let op: stabiel? loopt hij op? zakt hij weg? slaat hij af?",
    choices: [
      { label: "Stabiel 60 sec (netjes, voorspelbaar)", sub:"Ga door naar ‘rev return’ test.", next: "idle_rev_return", tag:"safe" },
      { label: "Loopt op in toeren (‘runs away’) en sterft daarna", sub:"Meestal LSN te lean óf luchtlek. In tuning: eerst LSN richer.", next: "adj_lsn_richer_1_8_from_idle", tag:"warn" },
      { label: "Zakt weg / verzuipt en sterft", sub:"Meestal LSN te rich. In tuning: LSN iets leaner.", next: "adj_lsn_leaner_1_8_from_idle", tag:"advice" }
    ]
  },

  idle_rev_return: {
    title: "IDLE test 2/5",
    headline: "Korte rev: hoe komt hij terug naar idle?",
    hint:
      "Geef 1× een korte rev (even gas) en laat los.\n" +
      "Kies wat je ziet:",
    choices: [
      { label: "Komt snel terug naar normaal idle (geen hangen)", sub:"Mooi. Ga door naar pinch test (LSN-check).", next: "lsn_pinch_test", tag:"safe" },
      { label: "Blijft hoog hangen (‘hang idle’) en zakt langzaam", sub:"Typisch LSN te lean of luchtlek. Eerst LSN richer.", next: "adj_lsn_richer_1_8_from_idle", tag:"warn" },
      { label: "Zakt te ver door / bijna uit na rev", sub:"Typisch LSN te rich. Eerst LSN leaner.", next: "adj_lsn_leaner_1_8_from_idle", tag:"advice" }
    ]
  },

  /* ---------------- LSN TESTS ---------------- */
  lsn_pinch_test: {
    title: "LSN test 1/6",
    headline: "Pinch test (brandstofslang even dichtknijpen op idle)",
    hint:
      "Knijp de brandstofslang dicht terwijl hij stationair draait.\n" +
      "Wat gebeurt er binnen enkele seconden?",
    choices: [
      { label: "Toeren stijgen na ~2–3 sec en dan valt hij uit", sub:"LSN meestal dichtbij goed.", next: "lsn_launch_test", tag:"safe" },
      { label: "Hij valt vrijwel direct uit (0–1 sec)", sub:"LSN te lean → richer.", next: "adj_lsn_richer_1_8", tag:"warn" },
      { label: "Hij blijft lang doorlopen (4+ sec) en verandert weinig", sub:"LSN te rich → leaner.", next: "adj_lsn_leaner_1_8", tag:"advice" },
      { label: "Ik wil deze test overslaan", sub:"Geen probleem. Ga naar wegrijtest.", next: "lsn_launch_test", tag:"advice" }
    ]
  },

  lsn_launch_test: {
    title: "LSN test 2/6",
    headline: "Wegrijtest: van idle naar ~1/4 gas",
    hint:
      "Laat hem 10–15 sec idle, geef dan rustig ~1/4 gas en laat hem wegrollen.\n" +
      "Kies het beste matchende gedrag:",
    choices: [
      { label: "Stottert/bokt en valt bijna dood (weinig rook, scherp)", sub:"Te lean op LSN → richer.", next: "adj_lsn_richer_1_8", tag:"warn" },
      { label: "Gorgelt/verzuipt, veel rook, komt lui op gang", sub:"Te rich op LSN → leaner.", next: "adj_lsn_leaner_1_8", tag:"advice" },
      { label: "Pakt netjes op, rolt soepel weg, kleine rookpluim", sub:"LSN lijkt goed. Ga naar 1/2 throttle transitie test.", next: "lsn_mid_transition_test", tag:"safe" }
    ]
  },

  lsn_mid_transition_test: {
    title: "LSN test 3/6",
    headline: "Transitie: van ~1/4 naar ~1/2 gas",
    hint:
      "Rijd rustig weg op 1/4 gas en geef dan door naar ~1/2.\n" +
      "Let op ‘bog’ (verslikken), rook, en hoe snel hij op toeren komt.",
    choices: [
      { label: "Bog/verslikt bij doorhalen, veel rook, dof geluid", sub:"Vaak nog iets te rich op low/mid → LSN iets leaner.", next: "adj_lsn_leaner_1_16", tag:"advice" },
      { label: "Hapt/schiet scherp maar zakt dan weg, weinig rook", sub:"Vaak te lean op low/mid → LSN iets richer.", next: "adj_lsn_richer_1_16", tag:"warn" },
      { label: "Trek soepel door richting 1/2 gas, gezonde rook", sub:"Goed. Ga naar hang-idle check na rijden.", next: "lsn_post_run_idle_check", tag:"safe" }
    ]
  },

  lsn_post_run_idle_check: {
    title: "LSN test 4/6",
    headline: "Na een korte run: hoe is je idle nu?",
    hint:
      "Rijd 15–20 sec rustig, stop, laat los naar idle.\n" +
      "Kies wat je ziet:",
    choices: [
      { label: "Idle blijft netjes stabiel", sub:"Mooi. Dan naar HSN (full throttle) tests.", next: "hsn_full_throttle_symptoms", tag:"safe" },
      { label: "Idle hangt hoog (blijft lang hoog)", sub:"Te lean op LSN óf luchtlek → eerst LSN richer.", next: "adj_lsn_richer_1_16", tag:"warn" },
      { label: "Idle zakt weg / pruttelt en dreigt uit te vallen", sub:"Te rich op LSN → iets leaner.", next: "adj_lsn_leaner_1_16", tag:"advice" }
    ]
  },

  /* ---------------- HSN TESTS ---------------- */
  hsn_full_throttle_symptoms: {
    title: "HSN test 1/6",
    headline: "Full throttle: kies het symptoom dat je ziet",
    hint:
      "Geef vol gas (recht stuk) en kijk/luister:\n" +
      "• Te lean: weinig rook, scherp/hoog geluid, wordt heet, power zakt weg, kan ineens afslaan.\n" +
      "• Te rich: veel rook, dof/gorgelend, komt niet lekker op toeren, bogt, mist topsnelheid.\n\n" +
      "Kies het beste matchende gedrag:",
    choices: [
      { label: "Power drop / wil niet doortrekken + weinig rook + ‘scherp’ geluid", sub:"HSN te lean → richer (veiliger).", next: "adj_hsn_richer_1_8", tag:"warn" },
      { label: "Veel rook + dof/gorgelend + mist topsnelheid", sub:"HSN te rich → iets leaner.", next: "adj_hsn_leaner_1_8", tag:"advice" },
      { label: "Trekt netjes door met zichtbare rooktrail", sub:"Mooi. Dan naar 5-sec WOT check.", next: "hsn_5sec_wot_check", tag:"safe" }
    ]
  },

  hsn_5sec_wot_check: {
    title: "HSN test 2/6",
    headline: "5 seconden WOT: blijft hij strak of zakt hij weg?",
    hint:
      "Geef 5 sec vol gas. Kijk of hij ‘blijft dragen’ of wegzakt.\n" +
      "Kies wat je merkt:",
    choices: [
      { label: "Blijft dragen, geen wegzakken, rook aanwezig", sub:"Goed. Dan temp check (hot laps).", next: "temp_hot_laps_check", tag:"safe" },
      { label: "Na 2–5 sec zakt hij weg / houdt in (en rook verdwijnt)", sub:"Vaak te lean/te heet → HSN richer.", next: "adj_hsn_richer_1_8", tag:"warn" },
      { label: "Na 2–5 sec begint hij te ‘blubberen’ (rijk) en versnelt niet", sub:"Vaak te rich → HSN iets leaner.", next: "adj_hsn_leaner_1_16", tag:"advice" }
    ]
  },

  /* ---------------- TEMP + IDLE WRAP ---------------- */
  temp_hot_laps_check: {
    title: "Temp test 1/4",
    headline: "Hot laps + temperatuur: wat is je situatie?",
    hint:
      "Rijd een paar rondjes ‘door’ en check temp.\n" +
      "Richtlijn: <210° oké, >230° te heet (afhankelijk van meetplek).\n\n" +
      "Kies wat klopt:",
    choices: [
      { label: "Temp <210° en hij rijdt goed", sub:"Ga door naar brake/idle test.", next: "idle_brake_test", tag:"safe" },
      { label: "Temp >230° of stijgt snel + weinig rook", sub:"Te lean → HSN richer.", next: "adj_hsn_richer_1_8", tag:"warn" },
      { label: "Temp oké maar hij rookt extreem en voelt lui", sub:"Nog iets te rich → HSN iets leaner.", next: "adj_hsn_leaner_1_16", tag:"advice" }
    ]
  },

  idle_brake_test: {
    title: "IDLE test 3/5",
    headline: "Remtest: slaat hij af bij remmen / idle load?",
    hint:
      "Rijd langzaam, rem af naar stilstand, laat idle.\n" +
      "Kies wat gebeurt:",
    choices: [
      { label: "Slaat af bij remmen / bij stoppen", sub:"Idle vaak te laag → idle iets omhoog.", next: "adj_idle_up_1_8", tag:"advice" },
      { label: "Blijft lopen", sub:"Mooi. Ga naar ‘wielen draaien’ check.", next: "idle_wheels_turning_check", tag:"safe" }
    ]
  },

  idle_wheels_turning_check: {
    title: "IDLE test 4/5",
    headline: "Stationair: draaien de wielen mee?",
    hint:
      "Zet hem neer, laat idle.\n" +
      "Kies wat je ziet:",
    choices: [
      { label: "Wielen draaien mee", sub:"Idle te hoog → idle iets omlaag.", next: "adj_idle_down_1_8", tag:"advice" },
      { label: "Wielen staan stil, idle stabiel", sub:"Top. Einde-check.", next: "final_ok", tag:"safe" }
    ]
  },

  final_ok: {
    title: "Einde",
    headline: "Je tuning ziet er goed uit ✅",
    hint:
      "Samenvatting:\n" +
      "• LSN: goede transitie idle → gas, geen hang idle, pinch ~2–3 sec\n" +
      "• HSN: rooktrail aanwezig, geen power drop, temp oké\n" +
      "• IDLE: stopt niet af bij remmen, wielen draaien niet mee\n\n" +
      "Tip: liever nét iets richer dan te lean (veiliger).",
    choices: [
      { label: "Terug naar start", next: "start", tag:"safe" },
      { label: "Ga naar log & herstel", next: "jump_log", tag:"advice" }
    ]
  },
  jump_log: { jumpToView: "log" },

  /* =======================
     ADJUSTMENTS (auto logged)
     - still small, but many tests lead here
  ======================= */
  adj_lsn_richer_1_8_from_idle: { adjust:{needle:"LSN", dir:"CCW", step:"1/8", note:"Auto: LSN richer (idle runaway/hang)."}, next:"idle_stability_60s" },
  adj_lsn_leaner_1_8_from_idle: { adjust:{needle:"LSN", dir:"CW",  step:"1/8", note:"Auto: LSN leaner (idle drowning)."}, next:"idle_stability_60s" },

  adj_lsn_richer_1_8: { adjust:{needle:"LSN", dir:"CCW", step:"1/8", note:"Auto: LSN richer (lean launch/pinch)."}, next:"lsn_launch_test" },
  adj_lsn_leaner_1_8: { adjust:{needle:"LSN", dir:"CW",  step:"1/8", note:"Auto: LSN leaner (rich launch/pinch)."}, next:"lsn_launch_test" },

  adj_lsn_richer_1_16:{ adjust:{needle:"LSN", dir:"CCW", step:"1/16",note:"Auto: LSN micro richer (fine)."}, next:"lsn_post_run_idle_check" },
  adj_lsn_leaner_1_16:{ adjust:{needle:"LSN", dir:"CW",  step:"1/16",note:"Auto: LSN micro leaner (fine)."}, next:"lsn_post_run_idle_check" },

  adj_hsn_richer_1_8: { adjust:{needle:"HSN", dir:"CCW", step:"1/8", note:"Auto: HSN richer (lean/heat/power drop)."}, next:"hsn_full_throttle_symptoms" },
  adj_hsn_leaner_1_8: { adjust:{needle:"HSN", dir:"CW",  step:"1/8", note:"Auto: HSN leaner (too rich at WOT)."}, next:"hsn_full_throttle_symptoms" },
  adj_hsn_leaner_1_16:{ adjust:{needle:"HSN", dir:"CW",  step:"1/16",note:"Auto: HSN micro leaner (fine)."}, next:"hsn_5sec_wot_check" },

  adj_idle_up_1_8:    { adjust:{needle:"IDLE",dir:"CW",  step:"1/8", note:"Auto: idle omhoog (slaat af bij remmen)."}, next:"idle_brake_test" },
  adj_idle_down_1_8:  { adjust:{needle:"IDLE",dir:"CCW", step:"1/8", note:"Auto: idle omlaag (wielen draaien)."}, next:"idle_wheels_turning_check" },
};

/* =========================
   State + storage
========================= */
const STORAGE_KEY="nitroWizardV4";
let state = {
  view:"wizard",
  node:"start",
  history:[],
  log:[],
  baselineIndex:0,
  baselineLabel:"Geen baseline gezet",
  carLabel:""
};

const $=(id)=>document.getElementById(id);
function nowStr(){ return new Date().toLocaleString(); }
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function load(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const parsed = JSON.parse(raw);
    if(parsed && parsed.node && FLOW[parsed.node]) state = parsed;
  }catch(e){}
}

function stepToNum(step){ const [a,b]=step.split("/").map(Number); return (!a||!b)?0:(a/b); }
function gcd(a,b){ while(b){ [a,b]=[b,a%b]; } return a; }
function numToPretty(n){
  const denom=16;
  const x=Math.round(n*denom);
  if(x===0) return "0";
  let a=x, b=denom;
  const g=gcd(a,b); a/=g; b/=g;
  return b===1 ? `${a}` : `${a}/${b}`;
}
function fmt(v){
  const sign=v>0?"+":v<0?"-":"";
  return `${sign}${numToPretty(Math.abs(v))} slag`;
}

function addLog(entry){
  state.log.push({ id: Math.random().toString(16).slice(2), t: nowStr(), ...entry });
  save();
}
function logAdjustment(needle, dir, step, note, source="auto"){
  const delta = stepToNum(step) * (dir==="CW" ? 1 : -1);
  addLog({ type:"adjust", needle, dir, step, delta, note: note||"", source });
}
function setBaseline(){
  state.baselineIndex = state.log.length;
  state.baselineLabel = `Baseline gezet (${nowStr()})`;
  save();
  renderAll();
}

function computeNetSinceBaseline(){
  const sum={IDLE:0,LSN:0,HSN:0};
  state.log.slice(state.baselineIndex).forEach(it=>{
    if(it.type!=="adjust") return;
    if(sum[it.needle]===undefined) return;
    sum[it.needle]+=it.delta;
  });
  return sum;
}

function copyLog(){
  const lines=[];
  lines.push("RC Nitro Tuning Log");
  lines.push("==================");
  lines.push(`Baseline: ${state.baselineLabel}`);
  if(state.carLabel) lines.push(`Notitie: ${state.carLabel}`);
  lines.push("");
  state.log.forEach(it=>{
    if(it.type==="adjust"){
      lines.push(`[AANPASSING] ${it.needle} ${it.dir} ${it.step}${it.note?` — ${it.note}`:""} (${it.t})`);
    } else {
      lines.push(`[NOTITIE] ${it.text} (${it.t})`);
    }
  });
  const sum=computeNetSinceBaseline();
  lines.push("");
  lines.push(`Netto sinds baseline (+=CW, -=CCW): IDLE ${fmt(sum.IDLE)}, LSN ${fmt(sum.LSN)}, HSN ${fmt(sum.HSN)}`);
  const text=lines.join("\n");
  navigator.clipboard.writeText(text).then(()=>alert("Log gekopieerd.")).catch(()=>prompt("Kopieer handmatig:", text));
}

function openUndoList(){
  const slice = state.log.slice(state.baselineIndex).filter(x=>x.type==="adjust");
  $("undoList").innerHTML="";
  if(slice.length===0){
    $("undoHint").textContent="Geen aanpassingen sinds baseline. Je staat volgens het log op origineel.";
  } else {
    $("undoHint").textContent="Draai onderstaande stappen terug (in deze volgorde) om terug te gaan naar baseline.";
    slice.slice().reverse().forEach(it=>{
      const oppositeDir = it.dir==="CW" ? "CCW" : "CW";
      const li=document.createElement("li");
      li.className="item";
      li.innerHTML=`
        <div class="itemTop">
          <div><span class="pill2 adjust">TERUGDRAAIEN</span></div>
          <div class="itemMeta">Was: ${it.needle} ${it.dir} ${it.step}</div>
        </div>
        <div class="itemMsg"><b>${it.needle}</b> ${oppositeDir} ${it.step}${it.note?` — ${escapeHtml(it.note)}`:""}</div>
      `;
      $("undoList").appendChild(li);
    });
  }
  $("modalUndo").style.display="block";
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
}

/* =========================
   Navigation
========================= */
function go(nodeId, from=null){
  const node = FLOW[nodeId];
  if(!node) return;

  if(node.jumpToView){
    state.view = node.jumpToView;
    save();
    renderAll();
    return;
  }

  state.history.push({ node: state.node, from });
  state.node = nodeId;

  // auto adjustment nodes
  if(node.adjust){
    logAdjustment(node.adjust.needle, node.adjust.dir, node.adjust.step, node.adjust.note, "auto");
    // immediately continue to next test step
    const next = node.next;
    save();
    state.node = next;
  }

  save();
  renderAll();
}

function back(){
  if(state.history.length===0) return;
  const prev=state.history.pop();
  state.node=prev.node;
  save();
  renderAll();
}

function restartWizard(){
  if(!confirm("Wizard opnieuw? (Log blijft staan)")) return;
  state.node="start";
  state.history=[];
  save();
  renderAll();
}

/* =========================
   Views + render
========================= */
function setView(v){
  state.view=v;
  save();
  renderAll();
}

function renderTabs(){
  $("tabWizard").classList.toggle("active", state.view==="wizard");
  $("tabLog").classList.toggle("active", state.view==="log");
  $("tabSettings").classList.toggle("active", state.view==="settings");
  $("statusPill").textContent = state.view==="wizard" ? "Wizard" : state.view==="log" ? "Log & herstel" : "Instellingen";
  $("baselineLabel").textContent = state.baselineLabel;
}

function renderWizard(){
  const node = FLOW[state.node];
  $("stepTitle").textContent = node.title || "Test";
  $("stepHeadline").textContent = node.headline || "";
  $("stepHint").textContent = node.hint || "";

  const col=$("choiceCol");
  col.innerHTML="";

  (node.choices||[]).forEach(ch=>{
    const btn=document.createElement("button");
    btn.className="choice";
    const t = ch.tag==="safe" ? "GOED" : ch.tag==="warn" ? "LET OP" : ch.tag==="stop" ? "STOP" : "ADVIES";
    const cls = ch.tag || "advice";
    btn.innerHTML = `<span class="tag ${cls}">${t}</span>${escapeHtml(ch.label)}${ch.sub?`<small>${escapeHtml(ch.sub)}</small>`:""}`;
    btn.onclick = ()=> go(ch.next, ch.label);
    col.appendChild(btn);
  });

  $("btnBack").disabled = state.history.length===0;
}

function renderLogPreview(){
  const ul=$("logPreview");
  ul.innerHTML="";
  const items = state.log.slice(-8).reverse();
  if(items.length===0){
    const li=document.createElement("li");
    li.className="item";
    li.innerHTML=`<div class="itemMsg">Nog geen log-items. Gebruik “+ Log aanpassing”.</div>`;
    ul.appendChild(li);
    return;
  }
  items.forEach(it=>{
    const li=document.createElement("li");
    li.className="item";
    const tag = it.type==="adjust" ? `<span class="pill2 adjust">AANPASSING</span>` : `<span class="pill2 note">NOTITIE</span>`;
    const msg = it.type==="adjust"
      ? `<b>${it.needle}</b> ${it.dir} ${it.step}${it.note?` — ${escapeHtml(it.note)}`:""}`
      : escapeHtml(it.text||"");
    li.innerHTML=`
      <div class="itemTop">
        <div>${tag}</div>
        <div class="itemMeta">${escapeHtml(it.t)}</div>
      </div>
      <div class="itemMsg">${msg}</div>
    `;
    ul.appendChild(li);
  });
}

function renderLogView(){
  const sum=computeNetSinceBaseline();
  $("stepTitle").textContent="Log & herstel";
  $("stepHeadline").textContent="Alles wat je deed — en hoe je teruggaat.";
  $("stepHint").textContent =
    `Baseline: ${state.baselineLabel}\n` +
    `Netto sinds baseline (+=CW, -=CCW): IDLE ${fmt(sum.IDLE)}, LSN ${fmt(sum.LSN)}, HSN ${fmt(sum.HSN)}`;

  const col=$("choiceCol");
  col.innerHTML="";

  const b1=document.createElement("button");
  b1.className="choice";
  b1.innerHTML=`<span class="tag advice">ACTIE</span> + Log aanpassing`;
  b1.onclick=()=>openQuickLog();
  col.appendChild(b1);

  const b2=document.createElement("button");
  b2.className="choice";
  b2.innerHTML=`<span class="tag warn">ACTIE</span> Herstel-lijst (terug naar baseline)`;
  b2.onclick=openUndoList;
  col.appendChild(b2);

  const b3=document.createElement("button");
  b3.className="choice";
  b3.innerHTML=`<span class="tag safe">ACTIE</span> Baseline vastzetten`;
  b3.onclick=setBaseline;
  col.appendChild(b3);

  const b4=document.createElement("button");
  b4.className="choice";
  b4.innerHTML=`<span class="tag advice">ACTIE</span> Kopieer log`;
  b4.onclick=copyLog;
  col.appendChild(b4);

  const listTitle=document.createElement("div");
  listTitle.style.marginTop="12px";
  listTitle.innerHTML=`<h2 style="margin:14px 0 8px; font-size:14px; color:var(--muted); font-weight:900;">Volledige log</h2>`;
  col.appendChild(listTitle);

  const ul=document.createElement("ul");
  ul.className="list";
  ul.style.maxHeight="320px";
  col.appendChild(ul);

  if(state.log.length===0){
    const li=document.createElement("li");
    li.className="item";
    li.innerHTML=`<div class="itemMsg">Nog geen items.</div>`;
    ul.appendChild(li);
  } else {
    state.log.slice().reverse().forEach(it=>{
      const li=document.createElement("li");
      li.className="item";
      const tag = it.type==="adjust" ? `<span class="pill2 adjust">AANPASSING</span>` : `<span class="pill2 note">NOTITIE</span>`;
      const msg = it.type==="adjust"
        ? `<b>${it.needle}</b> ${it.dir} ${it.step}${it.note?` — ${escapeHtml(it.note)}`:""}`
        : escapeHtml(it.text||"");
      li.innerHTML=`
        <div class="itemTop">
          <div>${tag}</div>
          <div class="itemMeta">${escapeHtml(it.t)}</div>
        </div>
        <div class="itemMsg">${msg}</div>
      `;
      ul.appendChild(li);
    });
  }
}

function renderSettings(){
  $("stepTitle").textContent="Instellingen";
  $("stepHeadline").textContent="Baseline = jouw originele setting.";
  $("stepHint").textContent =
    "Zet baseline als je op fabrieksinstellingen staat. Daarna kun je altijd terug via Herstel-lijst.\n" +
    "Je kunt ook een notitie opslaan (motor/brandstof/weer).";

  const col=$("choiceCol");
  col.innerHTML="";

  const base=document.createElement("button");
  base.className="choice";
  base.innerHTML=`<span class="tag safe">BASELINE</span> Baseline vastzetten <small>Huidig: ${escapeHtml(state.baselineLabel)}</small>`;
  base.onclick=setBaseline;
  col.appendChild(base);

  const note=document.createElement("div");
  note.className="item";
  note.innerHTML=`
    <div class="itemMsg">
      <b>Notitie (optioneel)</b><br>
      <input id="carLabelInput" type="text" placeholder="bijv. KE21SP • 25% nitro • 16°C"
        style="margin-top:8px; width:100%; padding:12px; border-radius:12px; border:1px solid var(--border); background: rgba(0,0,0,.25); color: var(--text); font-size:15px;">
      <div class="miniRow" style="margin-top:10px;">
        <button class="btnNext" id="saveNoteBtn">Opslaan</button>
        <button class="btnGhost" id="goWizardBtn">Terug naar wizard</button>
      </div>
    </div>
  `;
  col.appendChild(note);

  setTimeout(()=>{
    $("carLabelInput").value = state.carLabel || "";
    $("saveNoteBtn").onclick = ()=>{
      state.carLabel = $("carLabelInput").value.trim();
      save();
      alert("Opgeslagen.");
    };
    $("goWizardBtn").onclick = ()=> setView("wizard");
  },0);
}

function renderAll(){
  renderTabs();
  if(state.view==="wizard"){
    renderWizard();
    renderLogPreview();
    $("sideCard").style.display="";
  } else if(state.view==="log"){
    renderLogView();
    renderLogPreview();
    $("sideCard").style.display="none";
  } else {
    renderSettings();
    renderLogPreview();
    $("sideCard").style.display="none";
  }
}

/* =========================
   Manual log modal
========================= */
function openQuickLog(){
  $("logNeedle").value="LSN";
  $("logDir").value="CW";
  $("logStep").value="1/8";
  $("logNote").value="";
  $("modal").style.display="block";
}
function closeQuickLog(){ $("modal").style.display="none"; }

$("logCancel").onclick = closeQuickLog;
$("logSave").onclick = ()=>{
  logAdjustment($("logNeedle").value, $("logDir").value, $("logStep").value, $("logNote").value.trim(), "manual");
  closeQuickLog();
  renderAll();
};

$("modal").addEventListener("click",(e)=>{ if(e.target.id==="modal") closeQuickLog(); });
$("undoClose").onclick = ()=> $("modalUndo").style.display="none";
$("modalUndo").addEventListener("click",(e)=>{ if(e.target.id==="modalUndo") $("modalUndo").style.display="none"; });

/* =========================
   Buttons + Tabs
========================= */
$("tabWizard").onclick = ()=> setView("wizard");
$("tabLog").onclick = ()=> setView("log");
$("tabSettings").onclick = ()=> setView("settings");

$("btnBack").onclick = ()=>{
  if(state.view!=="wizard"){ setView("wizard"); return; }
  back();
};
$("btnRestart").onclick = restartWizard;
$("btnQuickLog").onclick = openQuickLog;

$("btnCopyLog").onclick = copyLog;
$("btnUndoList").onclick = openUndoList;

load();
renderAll();

/* SW */
window.addEventListener("load", () => {
  if ("serviceWorker" in navigator) navigator.serviceWorker.register("./sw.js");
});
</script>
</body>
</html>
